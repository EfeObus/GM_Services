{% extends "base.html" %}

{% block title %}Insurance Requests - Admin - GM Services{% endblock %}

{% block content %}
<!-- Admin Header -->
<section class="py-4 bg-surface-100">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="text-white mb-1">Insurance Requests</h2>
                <p class="text-gray mb-0">Manage vehicle insurance service requests</p>
            </div>
            <div class="d-flex gap-2">
                <select class="form-select form-select-sm" onchange="filterByStatus(this.value)">
                    <option value="">All Status</option>
                    <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="processing" {% if status_filter == 'processing' %}selected{% endif %}>Processing</option>
                    <option value="quoted" {% if status_filter == 'quoted' %}selected{% endif %}>Quoted</option>
                    <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                </select>
            </div>
        </div>
    </div>
</section>

<!-- Requests Table -->
<section class="py-5">
    <div class="container">
        <div class="gm-card">
            <div class="gm-card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Request #</th>
                                <th>Customer</th>
                                <th>Vehicle</th>
                                <th>Insurance Type</th>
                                <th>Coverage</th>
                                <th>Status</th>
                                <th>Premium</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for request in requests %}
                                <tr>
                                    <td class="text-white">{{ request.request_number }}</td>
                                    <td>
                                        <div>
                                            <strong class="text-white">{{ request.customer.full_name }}</strong>
                                            <br>
                                            <small class="text-gray">{{ request.contact_phone }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong class="text-white">{{ request.vehicle_info }}</strong>
                                            <br>
                                            <small class="text-gray">
                                                {% if request.license_plate %}{{ request.license_plate }}{% endif %}
                                                {% if request.vehicle_value %} • ₦{{ "{:,.0f}".format(request.vehicle_value) }}{% endif %}
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong class="text-white">{{ request.insurance_type|replace('_', ' ')|title }}</strong>
                                            <br>
                                            <small class="text-gray">{{ request.coverage_type|replace('_', ' ')|title }}</small>
                                        </div>
                                    </td>
                                    <td class="text-gray">
                                        {% if request.coverage_amount %}
                                            ₦{{ "{:,.0f}".format(request.coverage_amount) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if request.status == 'completed' %}success{% elif request.status == 'approved' %}primary{% elif request.status == 'quoted' %}info{% elif request.status == 'processing' %}warning{% elif request.status == 'rejected' %}danger{% else %}secondary{% endif %}">
                                            {{ request.status|replace('_', ' ')|title }}
                                        </span>
                                    </td>
                                    <td class="text-success">
                                        {% if request.quoted_premium %}
                                            ₦{{ "{:,.0f}".format(request.quoted_premium) }}
                                        {% elif request.final_premium %}
                                            ₦{{ "{:,.0f}".format(request.final_premium) }}
                                        {% else %}
                                            Pending
                                        {% endif %}
                                    </td>
                                    <td class="text-gray">{{ request.created_at.strftime('%Y-%m-%d') if request.created_at else 'N/A' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="viewRequest({{ request.id }})" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" 
                                                onclick="updateRequest({{ request.id }})" title="Update">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="9" class="text-center text-gray py-4">
                                        <i class="fas fa-shield-alt fa-3x mb-3"></i>
                                        <br>
                                        No insurance requests found.
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="gm-card">
                    <div class="gm-card-body text-center">
                        <i class="fas fa-clipboard-list fa-2x text-primary mb-2"></i>
                        <h4 class="text-white">{{ requests|length }}</h4>
                        <p class="text-gray mb-0">Total Requests</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="gm-card">
                    <div class="gm-card-body text-center">
                        <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                        <h4 class="text-white">{{ requests|selectattr('status', 'equalto', 'pending')|list|length }}</h4>
                        <p class="text-gray mb-0">Pending</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="gm-card">
                    <div class="gm-card-body text-center">
                        <i class="fas fa-calculator fa-2x text-info mb-2"></i>
                        <h4 class="text-white">{{ requests|selectattr('status', 'equalto', 'quoted')|list|length }}</h4>
                        <p class="text-gray mb-0">Quoted</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="gm-card">
                    <div class="gm-card-body text-center">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <h4 class="text-white">{{ requests|selectattr('status', 'equalto', 'completed')|list|length }}</h4>
                        <p class="text-gray mb-0">Completed</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- View Request Modal -->
<div class="modal fade" id="viewRequestModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white">Insurance Request Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="requestDetails">
                <!-- Request details will be loaded here -->
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Request Modal -->
<div class="modal fade" id="updateRequestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white">Update Insurance Request</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('services.update_insurance_request', request_id=0) }}" id="updateForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="updateStatus" class="form-label text-gray">Status</label>
                        <select class="form-select" id="updateStatus" name="status">
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="quoted">Quoted</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="quotedPremium" class="form-label text-gray">Quoted Premium (₦)</label>
                        <input type="number" class="form-control" id="quotedPremium" name="quoted_premium" step="1000">
                    </div>
                    <div class="mb-3">
                        <label for="finalPremium" class="form-label text-gray">Final Premium (₦)</label>
                        <input type="number" class="form-control" id="finalPremium" name="final_premium" step="1000">
                    </div>
                    <div class="mb-3">
                        <label for="policyNumber" class="form-label text-gray">Policy Number</label>
                        <input type="text" class="form-control" id="policyNumber" name="policy_number">
                    </div>
                    <div class="mb-3">
                        <label for="updateNotes" class="form-label text-gray">Progress Notes</label>
                        <textarea class="form-control" id="updateNotes" name="notes" rows="3" 
                                  placeholder="Add progress notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Update Request</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function filterByStatus(status) {
    const url = new URL(window.location);
    if (status) {
        url.searchParams.set('status', status);
    } else {
        url.searchParams.delete('status');
    }
    window.location = url;
}

function viewRequest(requestId) {
    // Fetch request details via AJAX (to be implemented)
    document.getElementById('requestDetails').innerHTML = `
        <div class="text-center text-gray">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <br>
            Loading request details...
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('viewRequestModal'));
    modal.show();
    
    // TODO: Implement AJAX call to fetch request details
    setTimeout(() => {
        document.getElementById('requestDetails').innerHTML = `
            <div class="text-gray">
                <p><strong class="text-white">Request ID:</strong> ${requestId}</p>
                <p>Insurance request details would be loaded here via AJAX call.</p>
            </div>
        `;
    }, 1000);
}

function updateRequest(requestId) {
    // Set the form action URL
    document.getElementById('updateForm').action = `/services/admin/insurance-request/${requestId}/update`;
    
    // Clear form
    document.getElementById('updateStatus').value = '';
    document.getElementById('quotedPremium').value = '';
    document.getElementById('finalPremium').value = '';
    document.getElementById('policyNumber').value = '';
    document.getElementById('updateNotes').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('updateRequestModal'));
    modal.show();
}
</script>
{% endblock %}